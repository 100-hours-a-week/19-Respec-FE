name: Deploy Frontend to EC2

on:
  push:
    branches:
      - stage
# on:
#   workflow_dispatch:
#     inputs: 
#       tags:
#         description: 'Set Tags Name'
#         required: true
#         type: string
#         default: master
          
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

<<<<<<< HEAD
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            if [ ! -d "19-Respec-FE" ]; then
              git clone https://github.com/100-hours-a-week/19-Respec-FE.git
            fi

            cd 19-Respec-FE
            git checkout stage
            git pull origin stage

            npm install
            npm run build

            echo "ğŸ” ê¸°ì¡´ serve í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œë„..."
            PORT_PID=$(lsof -i:3000 -t || true)
            if [ -n "$PORT_PID" ]; then
              echo "ğŸ”´ í¬íŠ¸ 3000 ì‚¬ìš© ì¤‘, í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID: $PORT_PID)"
              kill -9 $PORT_PID
            else
              echo "âœ… ì¢…ë£Œí•  í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            fi

=======
      # EC2 ìƒíƒœ ì²´í¬ (ì„ íƒ)
      # - name: Check EC2 status and start if stopped
      #   run: |
      #     INSTANCE_ID=${{ secrets.EC2_INSTANCE_ID }}
      #     STATE=$(aws ec2 describe-instances \
      #       --instance-ids $INSTANCE_ID \
      #       --query "Reservations[0].Instances[0].State.Name" \
      #       --output text)
      #
      #     if [ "$STATE" = "stopped" ]; then
      #       aws ec2 start-instances --instance-ids $INSTANCE_ID
      #       aws ec2 wait instance-running --instance-ids $INSTANCE_ID
      #     fi

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |

            if [ ! -d "19-RESPEC-FE" ]; then
              git clone https://github.com/100-hours-a-week/19-Respec-FE.git
            fi

            cd 19-Respec-FE
            git checkout stage
            npm install
            npm run build

            echo "ğŸ” ê¸°ì¡´ serve í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œë„..."
            PORT_PID=$(lsof -i:3000 -t || true)
            if [ -n "$PORT_PID" ]; then
              echo "ğŸ”´ í¬íŠ¸ 3000 ì‚¬ìš© ì¤‘, í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID: $PORT_PID)"
              kill -9 $PORT_PID
            else
              echo "âœ… ì¢…ë£Œí•  í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            fi

>>>>>>> dev
            echo "ğŸš€ serve ì‹¤í–‰ ì‹œì‘ (build)..."
            nohup npx serve -s build -l 3000 > frontend.log 2>&1 &
            echo "âœ… serve ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ ì™„ë£Œ"
